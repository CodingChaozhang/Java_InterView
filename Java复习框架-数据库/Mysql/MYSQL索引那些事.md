# Mysql索引那些事

## Mysql索引是什么？

索引就是一种用于快速查找数据的数据结构，是帮助MySQL高效获取数据的排好序的数据结构。

## Mysql索引好处是什么？

假设我们有一个表t，它有俩字段，Col1和Col2，如下：

**不加索引**

不加索引的情况下，SQL： `select * from t where t.col2=89` ，需要从表的第一行一行行遍历比对col2的值是否等于89，这样需要比对6次才能查到。这只是只有几行记录的表，那如果是百万级千万级的表呢？是不是就比较的次数就更多了，那还不得慢死。

**加索引**

如果col2这列加了索引，mysql内部会维护一个数据结构。假设mysql用的数据结构是红黑树（右子树的元素大于根节点，左子树的元素小于根节点）的数据结构建立索引，那就像上图右边那样。这样的话，刚才的那条SQL是不是只需要2次磁盘IO就查到了，是不是快很多了。

这就是索引的好处。索引使用比较巧妙的数据结构，利用数据结构的特性来大大减少查找遍历次数。

## 索引底层数据结构的探索

索引可选的数据结构：

- hash结构
- 二叉树
- 二叉搜索树
- 平衡二叉树
- 红黑树
- B树

- B+树

### (1) 为什么不用二叉树、二叉搜索树、平衡二叉树、红黑树做数据结构？

如果用这些数据结构来作为表来记录，树的高度会极其高，那数百万数千万甚至上亿记录的表创建的索引它的树高有多高呢？

假如树的高度是50，那么需要进行50次查找，50次I/O开销查询时间：树的高度过高导致查询效率变慢。

> I/O开销时间=旋转时间+寻道时间+数据传输时间(最耗时是寻道时间)。

B树和B+树就是这样的多个分叉，横向存储越多，树高就越小。

### (2)B+树和B-Tree的区别是什么？为什么用B+树呢？

- B+树的非叶子结点没有数据，数据都挪到了叶子结点；

- 叶子结点之间还有指针，非叶子结点之间跟原来一样没有指针；
- B+树结点的关键点个数比B树要多一个；

**那为什么data元素挪到了叶子结点？**

非叶子结点只存储索引元素，**叶子结点存储了一份完整表的所有行的索引字段**，**data元素是每个索引对应要查找的记录的位置或者行数据。**这样非叶子结点的每个节点就可以存储更多的索引元素，实际上非叶子结点存储的是一些冗余索引。

**把中间的元素提取出来做冗余元素，为的是查找效率更高。把冗余索引的data元素搞到叶子结点，非叶子结点就可以存储更多的关键点个数了。因为一个结点不能太大也不能太小，就是16K，把data元素挪走以后，这个节点就可以存储更多的冗余索引了。**

### (3) InnoDb中一棵B+树到底能存多少行数据呢？

在InooDb中一棵高度为3的B+树可以存放约2kw的数据。

**a.最小存储单元**

在计算中磁盘存储数据最小单位是扇区，一个扇区的大小是512字节；而文件系统它的最小单位是块，一个块的大小是4k，而InnoDb存储引擎也有自己的最小存储单元，页(Page)，一个页的大小是16k。

**b.InooDB中主键索引B+树是如何组织数据、查询数据的呢？**

- InnoDB存储引擎的最小存储单元是页，页可以用于**存放数据**也可以用于**存放键值+指针，**在B+树中叶子结点存放数据，非叶子结点存放键值+指针。

**c.那么通常一棵B+树可以存放多少行的数据呢？**

先假设B+树高为2，那么就是存在一个根节点和若干个叶子结点，那么这棵B+树的存放总记录数为：根节点指针数*单个叶子结点记录行数。

单个叶子结点(页)中的记录数=16K/1K=16。（这里假设一行记录的数据大小为1k，实际上很多互联网数据记录大小通常就是1k左右。）

那么需要计算非叶子结点能存放多少指针呢？假设主键ID为bigint，长度为8字节，而指针大小在InnoDB源码中设置为6字节，这样一共14字节，那么一页能存放多少这样的单元，就代表有多少指针，即16384/14=1170.

那一棵高度为2的B+树，能存放1170*16=18720条这样的数据记录。

根据同样的原理可以算出一个高度为3的B+树可以存放：1170*1170*16=21902400这样的记录。

**所以，在InnoD中B+树高度一般为1-3层，它就能满足千万级的数据存储。**



